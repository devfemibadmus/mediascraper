# @format

name: Deploy to VPS

on:
    push:
        branches: [main]

jobs:
    test-and-build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Build
              run: cargo build --release --verbose

            - name: Run tests
              run: cargo test --verbose

            - name: Deploy to VPS
              if: success()
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      export PATH="$HOME/.cargo/bin:$PATH"
                      cd /home/mediascraper
                      git pull origin main
                      cargo build --release
                      sudo systemctl restart mediascraper
