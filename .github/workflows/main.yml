# @format

name: Build and Deploy

on:
    push:
        branches: [main]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  override: true

            - name: Cache dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Build release binary
              run: cargo build --release

            - name: Run tests
              run: cargo test

            - name: Upload binary to VPS
              uses: appleboy/scp-action@v0.1.4
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  source: "target/release/mediascraper"
                  target: ${{ secrets.VPS_APP_PATH }}

            - name: Restart service on VPS
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      chmod +x ${{ secrets.VPS_APP_PATH }}/mediascraper
                      sudo systemctl restart mediascraper
                      echo "Deployment complete!"
